var ProtoFish=Class.create({initialize:function(d,b,a,c){this.id=d;this.timeout=(b==undefined)?"400":b;this.cssClass=(a==undefined)?"hover":a;this.remActive=(c==undefined)?false:c;this.queue=[];this.activeTimeout="";this.menuFocus=false;this.menuCount=0;this.shiftDown=false;if($(d)&&$(d).down()){this.listItems=$(d).select("li");this.activeItems=$(d).select("li.active");this.initObservers()}},initObservers:function(){this.listItems.each(function(a){a.observe("mouseover",function(c,b){this.enterMenu(b);b.addClassName(this.cssClass)}.bindAsEventListener(this,a));a.observe("mouseout",function(c,b){this.queue.push([this.leaveMenu.delay(this.timeout/1000,this),b])}.bindAsEventListener(this,a))}.bind(this));Event.observe(document,"keydown",function(a){this.keyBoardNav(a);if(a.keyCode==16){this.shiftDown=true}}.bind(this));Event.observe(document,"keyup",function(a){if(a.keyCode==16){this.shiftDown=false}}.bind(this));Event.observe(document,"click",function(b){var a=Event.element(b);if(a!=$(this.id)&&!a.descendantOf(this.id)&&this.menuFocus==true){this.listItems.invoke("removeClassName",this.cssClass);this.menuFocus=false}}.bind(this));$$("body")[0].observe("focusin",this.handleMenuFocus.bind(this));if(window.addEventListener){$$("body")[0].addEventListener("focus",this.handleMenuFocus.bind(this),true)}},handleMenuFocus:function(b){var a=Event.element(b);if(a.up("#"+this.id)){this.menuFocus=true;this.menuCount=this.listItems.indexOf(a.up("li"));a.up("li").addClassName(this.cssClass)}else{this.listItems.invoke("removeClassName",this.cssClass);this.menuFocus=false}},keyBoardNav:function(e){var d=e.keyCode;if(this.menuFocus==true&&d==Event.KEY_TAB){if(this.shiftDown==false){this.menuCount++;var a=this.listItems[this.menuCount-1];if(!a.down("li")){a.removeClassName(this.cssClass);while(a.up("li")&&!a.next("li")){a.up("li").removeClassName(this.cssClass);a=a.up("li")}}}else{if(this.shiftDown==true){this.menuCount--;var c=this.listItems[this.menuCount];var b=this.listItems[this.menuCount+1];b.removeClassName(this.cssClass);if(c){while(c.up("li")&&c.up("li").hasClassName(this.cssClass)==false){c.up("li").addClassName(this.cssClass);c=c.up("li")}}}}}if(this.menuFocus==true&&d==Event.KEY_DOWN){e.preventDefault();var c=this.listItems[this.menuCount];if(!c.up("li")){var b=c.down("li")}else{var b=(c.next("li"))?c.next("li"):false;if(b){c.removeClassName(this.cssClass)}}if(b){this.menuCount=this.listItems.indexOf(b);b.addClassName(this.cssClass);b.down("a").focus()}}if(this.menuFocus==true&&d==Event.KEY_UP){e.preventDefault();var c=this.listItems[this.menuCount];if(!c.up("li")){var a=false}else{var a=(c.previous("li"))?c.previous("li"):c.up("li");c.removeClassName(this.cssClass)}if(a){this.menuCount=this.listItems.indexOf(a);a.addClassName(this.cssClass);a.down("a").focus()}}if(this.menuFocus==true&&d==Event.KEY_RIGHT){e.preventDefault();var c=this.listItems[this.menuCount];if(!c.up("li")){var f=c.next("li");if(f){c.removeClassName(this.cssClass)}}else{var f=(c.down("li"))?c.down("li"):false}if(f){this.menuCount=this.listItems.indexOf(f);f.addClassName(this.cssClass);f.down("a").focus()}}if(this.menuFocus==true&&d==Event.KEY_LEFT){e.preventDefault();var c=this.listItems[this.menuCount];if(!c.up("li")){var g=c.previous("li");if(g){c.removeClassName(this.cssClass)}}else{var g=(c.up("li"))?c.up("li"):false;if(g){c.removeClassName(this.cssClass)}}if(g){this.menuCount=this.listItems.indexOf(g);g.addClassName(this.cssClass);g.down("a").focus()}}if(this.menuFocus==true&&d==Event.KEY_ESC){this.listItems.invoke("removeClassName",this.cssClass);this.menuFocus=false}},enterMenu:function(){while(this.queue.length){clearTimeout(this.queue[0][0]);this.leaveMenu(this)}if(this.remActive==true){if(typeof this.activeTimeout=="number"){clearTimeout(this.activeTimeout);delete this.activeTimeout}this.activeItems.invoke("removeClassName","active")}},leaveMenu:function(b){if(b.queue.length){var a=b.queue.shift()[1];a.removeClassName(b.cssClass)}if(b.remActive==true){b.activeItems.invoke("addClassName","active")}}});